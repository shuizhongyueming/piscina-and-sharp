# piscina-and-sharp

This repository provides minimal and focused examples to reproduce and investigate issues with transferring `Buffer`/`ArrayBuffer` objects generated by the [sharp](https://github.com/lovell/sharp) image processing library between threads in Node.js, both using [Piscina](https://github.com/piscinajs/piscina) and the native [`worker_threads`](https://nodejs.org/api/worker_threads.html) module.

## Background

- In Node.js v22.x, attempting to transfer the underlying `ArrayBuffer` of a `Buffer` returned by `sharp().toBuffer()` between threads (using `postMessage` with a transfer list) can fail with a `DataCloneError: Cannot transfer object of unsupported type.`
- This issue does **not** occur in Node.js v20.x.
- Creating a new `Buffer` via `Buffer.from(sharpBuffer)` or copying the `ArrayBuffer` via `.slice()` produces a transferable buffer and works as expected.

## Structure

- `piscina/`
  Demonstrates the issue using Piscina worker pool and sharp, including complex object transfer and workaround.
- `worker/`
  A minimal reproduction using only Node.js native `worker_threads` and sharp, with and without the workaround.

## How to Run

1. Install dependencies:
    ```bash
    pnpm install
    ```
2. Run the Piscina example:
    ```bash
    pnpm run piscina
    ```
3. Run the native worker_threads example:
    ```bash
    # Without workaround
    pnpm run worker
    # With workaround
    pnpm run worker_copy
    ```

## What to Look For

- On Node.js v22.x, without the workaround, you should see a `DataCloneError` when trying to transfer the sharp buffer's underlying ArrayBuffer.
- With the workaround (`Buffer.from()`), the transfer succeeds.
- On Node.js v20.x, both approaches work.

## Related Issue

See [sharp issue #4355](https://github.com/lovell/sharp/issues/4355) for an in-depth discussion.
